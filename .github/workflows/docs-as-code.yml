name: Sync Docs as Code - Confluence
on:
  push:
    branches:
      - main
    paths:
      - "docs/**"

jobs:
  docs-as-code:
    runs-on: ubuntu-latest
    name: Sync Docs as Code - Confluence
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Detect docs changes
        id: changed-docs
        uses: tj-actions/changed-files@v46
        with:
          files: |
            *.md
            docs/*.md
      - name: Find Changed Markdown Files
        id: find-files
        if: steps.changed-docs.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-docs.outputs.all_changed_files }}
        run: |
          echo "Changed files:"
          echo "$CHANGED_FILES"
          # Format as JSON array for multi-file processing
          echo "files_json=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT
      - name: Test Confluence API Connection
        if: steps.changed-docs.outputs.any_changed == 'true'
        run: |
          echo "Testing Confluence API access..."
          RESPONSE=$(curl -s -u "${{ secrets.USERNAME }}:${{ secrets.API_TOKEN }}" \
            "${{ secrets.BASE_URL }}/rest/api/space/${{ secrets.SPACE_KEY }}")
          echo "API Response: $RESPONSE"
          if [[ $RESPONSE == *"\"statusCode\":401"* ]]; then
            echo "ERROR: Unauthorized (check username/api_token)"
            exit 1
          elif [[ $RESPONSE == *"\"statusCode\":404"* ]]; then
            echo "ERROR: Space not found (check space-key)"
            exit 1
          else
            echo "âœ… Confluence API access successful!"
          fi
      - name: Sync Docs as Code - Confluence
        if: steps.changed-docs.outputs.any_changed == 'true'
        uses: Bhacaz/docs-as-code-confluence@v3
        with:
          folder: docs
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.API_TOKEN }}
          confluence-base-url: ${{ secrets.BASE_URL }}
          space-key: ${{ secrets.SPACE_KEY }}
          parent-page-id: ${{ secrets.PARENT_PAGE_ID }}
